<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <title>c5-db-migration, migración de bases de datos</title>
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type' />
    <meta content=', c5-db, migration, database, java, maven' name='keywords' />
    <meta content='Ejemplo de migración de bases de datos para Java' name='description' />
    <link href='/assets/css/reset.css' rel='stylesheet' type='text/css' />
    <link href='/assets/css/style.css' media='screen' rel='stylesheet' type='text/css' />
  </head>
  <body>
    <div id='main'>
      <div id='header'>
        <div class='logo'>
          <a href='/'>&laquo; Miguel Triana - site</a>
        </div>
        <div id='nav'>
          <ul>
            <li><a href='/archives.html'>archives</a></li>
            <li><a href='/tags.html'>tags</a></li>
            <li><a href='/projects.html'>projects</a></li>
            <li><a href='/about.html'>about</a></li>
            <li><a href='/contact.html'>contact</a></li>
            <li>
              <a href='/atom.xml'>rss</a>
            </li>
          </ul>
        </div>
      </div>
      <div class='clear'></div>
      <div id='content'>
        <div class='article'>
              <h1>
                c5-db-migration, migración de bases de datos
              </h1>
              <div class='meta'>
                <ul class='tags'>
                  <li>Apr 25, 2011</li>
                  <li>
                    &middot;
                  </li>
                  <li>
                    <a href='/2011/04/27/ejemplo_c5_db.html#disqus_thread'></a>
                  </li>
                  <li>&middot;</li>
                  <li>
                    <a class='tag' href='/tags/c5-db/'>
                      c5-db
                    </a>
                  </li>
                  <li>
                    <a class='tag' href='/tags/database/'>
                      database
                    </a>
                  </li>
                  <li>
                    <a class='tag' href='/tags/java/'>
                      java
                    </a>
                  </li>
                  <li>
                    <a class='tag' href='/tags/maven/'>
                      maven
                    </a>
                  </li>
                  <li>
                    <a class='tag' href='/tags/migration/'>
                      migration
                    </a>
                  </li>
                </ul>
              </div>
              <div class='body'>
                <p>Ejemplo de migración de bases de datos para Java usando <a href='http://code.google.com/p/c5-db-migration/' target='_blank'>C5-DB-Migration</a> y <a href='http://maven.apache.org' target='_blank'>Maven</a></p>
                
                <ol>
                <li>Crear un projecto simple en Maven:
                <code>mvn archetype:create -DgroupId=com.example.db -DartifactId=db-project</code></li>
                <li>Adicionar el repositorio de Carbonfive
                <code class="xml"><table class="CodeRay"><tr>&#x000A;<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt>&#x000A;</tt>2<tt>&#x000A;</tt>3<tt>&#x000A;</tt>4<tt>&#x000A;</tt>5<tt>&#x000A;</tt>6<tt>&#x000A;</tt>7<tt>&#x000A;</tt>8<tt>&#x000A;</tt>9<tt>&#x000A;</tt><strong>10</strong><tt>&#x000A;</tt>11<tt>&#x000A;</tt>12<tt>&#x000A;</tt>13<tt>&#x000A;</tt></pre></td>&#x000A;<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><span style="color:#070">&lt;project</span> <span style="color:#007">...</span><span style="color:#070">&gt;</span><tt>&#x000A;</tt>  ...<tt>&#x000A;</tt>  <span style="color:#070">&lt;pluginRepositories&gt;</span><tt>&#x000A;</tt>    <span style="color:#070">&lt;pluginRepository&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;id&gt;</span>c5-public-repository<span style="color:#070">&lt;/id&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;url&gt;</span>http://mvn.carbonfive.com/public<span style="color:#070">&lt;/url&gt;</span><tt>&#x000A;</tt>    <span style="color:#070">&lt;/pluginRepository&gt;</span><tt>&#x000A;</tt>  <span style="color:#070">&lt;/pluginRepositories&gt;</span><tt>&#x000A;</tt>  ...<tt>&#x000A;</tt>  <span style="color:#070">&lt;build&gt;</span><tt>&#x000A;</tt>  ...<span style="color:#888">&lt;!-- Plugin --&gt;</span><tt>&#x000A;</tt>  <span style="color:#070">&lt;/build&gt;</span><tt>&#x000A;</tt><span style="color:#070">&lt;/project&gt;</span><tt>&#x000A;</tt></pre></td>&#x000A;</tr></table></code></li>
                <li>Adicionar el plug-in de C5-DB en el POM y el repositorio de CarbonFive
                <code class="xml"><table class="CodeRay"><tr>&#x000A;<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt>&#x000A;</tt>2<tt>&#x000A;</tt>3<tt>&#x000A;</tt>4<tt>&#x000A;</tt>5<tt>&#x000A;</tt>6<tt>&#x000A;</tt>7<tt>&#x000A;</tt>8<tt>&#x000A;</tt>9<tt>&#x000A;</tt><strong>10</strong><tt>&#x000A;</tt>11<tt>&#x000A;</tt>12<tt>&#x000A;</tt>13<tt>&#x000A;</tt>14<tt>&#x000A;</tt>15<tt>&#x000A;</tt>16<tt>&#x000A;</tt>17<tt>&#x000A;</tt>18<tt>&#x000A;</tt>19<tt>&#x000A;</tt><strong>20</strong><tt>&#x000A;</tt>21<tt>&#x000A;</tt>22<tt>&#x000A;</tt>23<tt>&#x000A;</tt>24<tt>&#x000A;</tt></pre></td>&#x000A;<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><span style="color:#070">&lt;build&gt;</span><tt>&#x000A;</tt>  ...<tt>&#x000A;</tt>  <span style="color:#070">&lt;plugins&gt;</span><tt>&#x000A;</tt>    <span style="color:#070">&lt;plugin&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;groupId&gt;</span>com.carbonfive.db-support<span style="color:#070">&lt;/groupId&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;artifactId&gt;</span>db-migration-maven-plugin<span style="color:#070">&lt;/artifactId&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;version&gt;</span>RELEASE<span style="color:#070">&lt;/version&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;configuration&gt;</span><tt>&#x000A;</tt>        <span style="color:#070">&lt;url&gt;</span>jdbc:postgresql://localhost:5432/teste2_migration<span style="color:#070">&lt;/url&gt;</span><tt>&#x000A;</tt>        <span style="color:#070">&lt;username&gt;</span>postgres<span style="color:#070">&lt;/username&gt;</span><tt>&#x000A;</tt>        <span style="color:#070">&lt;password&gt;</span>postgres<span style="color:#070">&lt;/password&gt;</span><tt>&#x000A;</tt>        <span style="color:#070">&lt;migrationsPath&gt;</span>${basedir}/src/c5_db/migrations<span style="color:#070">&lt;/migrationsPath&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;/configuration&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;dependencies&gt;</span><tt>&#x000A;</tt>        <span style="color:#070">&lt;dependency&gt;</span><tt>&#x000A;</tt>          <span style="color:#070">&lt;groupId&gt;</span>postgresql<span style="color:#070">&lt;/groupId&gt;</span><tt>&#x000A;</tt>          <span style="color:#070">&lt;artifactId&gt;</span>postgresql<span style="color:#070">&lt;/artifactId&gt;</span><tt>&#x000A;</tt>          <span style="color:#070">&lt;version&gt;</span>8.3-603.jdbc3<span style="color:#070">&lt;/version&gt;</span><tt>&#x000A;</tt>        <span style="color:#070">&lt;/dependency&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;/dependencies&gt;</span><tt>&#x000A;</tt>    <span style="color:#070">&lt;/plugin&gt;</span><tt>&#x000A;</tt>  <span style="color:#070">&lt;/plugins&gt;</span><tt>&#x000A;</tt>  ...<tt>&#x000A;</tt><span style="color:#070">&lt;/build&gt;</span><tt>&#x000A;</tt></pre></td>&#x000A;</tr></table></code></li>
                <li>Crear el directorio de migraciones: <code>mkdir src/c5_db/migrations -p</code> . Esta ubicación fue configurada en el plugin.</li>
                <li>Crear la primera migración: Usar el comando <code>mvn db-migration:new -Dname=nombre_de_migracion</code>. Este comando crea un archivo <em>sql</em> siguiendo el modelo <em>YYYYMMDDHHMMSS_nombre_de_migracion.sql</em>.
                
                <pre><code> mvn db-migration:new -Dname=base_inicial&#x000A;</code></pre></li>
                <li>Adicionar al archivo creado anteriormente el siguiente contenido:
                <code class="sql"><table class="CodeRay"><tr>&#x000A;<td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt>&#x000A;</tt>2<tt>&#x000A;</tt>3<tt>&#x000A;</tt>4<tt>&#x000A;</tt></pre></td>&#x000A;<td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><span style="color:#080;font-weight:bold">CREATE</span> <span style="color:#080;font-weight:bold">TABLE</span> test_user (<tt>&#x000A;</tt>  name <span style="color:#074;font-weight:bold">VARCHAR</span>(<span style="color:#00D;font-weight:bold">25</span>) <span style="color:#080;font-weight:bold">NOT</span> <span style="color:#038;font-weight:bold">NULL</span>,<tt>&#x000A;</tt>  <span style="color:#080;font-weight:bold">PRIMARY</span> <span style="color:#080;font-weight:bold">KEY</span>(name)<tt>&#x000A;</tt>);<tt>&#x000A;</tt></pre></td>&#x000A;</tr></table></code></li>
                <li><p>Migrar la base de datos: <code>mvn db-migration:migrate</code>. El resultado es el siguiente:</p>
                
                <pre><code> [INFO] Building db-project&#x000A; [INFO]    task-segment: [db-migration:migrate]&#x000A; [INFO] ------------------------------------------------------------------------&#x000A; [INFO] [db-migration:migrate {execution: default-cli}]&#x000A; [INFO] Migrating jdbc:postgresql://localhost:5432/teste2_migration using&#x000A; migrations at /path/to/project/db-project/src/c5_db/migrations.&#x000A; [INFO] Loaded JDBC driver: org.postgresql.Driver&#x000A; [INFO] Successfully enabled migrations.&#x000A; [INFO] Migrating database... applying 1 migration.&#x000A; [INFO] Running migration 20110428010126_base_inicial.sql.&#x000A; [INFO] Migrated database in 0:00:00.094.&#x000A; [INFO] ------------------------------------------------------------------------&#x000A;</code></pre></li>
                <li><p>Listo!, para revisar si base de datos esta actualizada y ver las migraciones pendientes, ejecutar: <code>mvn db-migration:validate</code>. Maven va a presentar un resultado similar al siguiente:</p>
                
                <pre><code> [INFO] ------------------------------------------------------------------------&#x000A; [INFO] Building db_migration Maven Webapp&#x000A; [INFO]    task-segment: [db-migration:validate]&#x000A; [INFO] ------------------------------------------------------------------------&#x000A; [INFO] [db-migration:validate {execution: default-cli}]&#x000A; [INFO] Validating jdbc:postgresql://localhost:5432/teste2_migration&#x000A; using migrations at /path/to/project/src/db_migration/src/c5_db/migrations.&#x000A; [INFO] Loaded JDBC driver: org.postgresql.Driver&#x000A; [INFO] &#x000A; Database: jdbc:postgresql://localhost:5432/teste2_migration&#x000A;       Up-to-date: true&#x000A;     Pending Migrations: &#x000A; [INFO] ------------------------------------------------------------------------&#x000A;</code></pre></li>
                <li>Para las siguientes migraciones ejecutar los pasos 5 a 7.</li>
                </ol>
                
                
                <p>También es posible verificar el estado de la base de datos y emitir un error durante la construcción del projecto si hay migraciones pendientes, adicionando el siguiente código en la configuración del plugin:
                <code class="xml"><table class="CodeRay"><tr>&#x000A;  <td class="line_numbers" title="click to toggle" onclick="with (this.firstChild.style) { display = (display == '') ? 'none' : '' }"><pre>1<tt>&#x000A;</tt>2<tt>&#x000A;</tt>3<tt>&#x000A;</tt>4<tt>&#x000A;</tt>5<tt>&#x000A;</tt>6<tt>&#x000A;</tt>7<tt>&#x000A;</tt>8<tt>&#x000A;</tt></pre></td>&#x000A;  <td class="code"><pre ondblclick="with (this.style) { overflow = (overflow == 'auto' || overflow == '') ? 'visible' : 'auto' }"><span style="color:#070">&lt;executions&gt;</span><tt>&#x000A;</tt>  <span style="color:#070">&lt;execution&gt;</span><tt>&#x000A;</tt>    <span style="color:#070">&lt;phase&gt;</span>validate<span style="color:#070">&lt;/phase&gt;</span><tt>&#x000A;</tt>    <span style="color:#070">&lt;goals&gt;</span><tt>&#x000A;</tt>      <span style="color:#070">&lt;goal&gt;</span>check<span style="color:#070">&lt;/goal&gt;</span><tt>&#x000A;</tt>    <span style="color:#070">&lt;/goals&gt;</span><tt>&#x000A;</tt>  <span style="color:#070">&lt;/execution&gt;</span><tt>&#x000A;</tt><span style="color:#070">&lt;/executions&gt;</span><tt>&#x000A;</tt></pre></td>&#x000A;</tr></table></code></p>
              </div>
            </div>
        <div id='other-articles'>
              <div class='older'>
                <ul>
                  <li>
                    <h3>
                      <a href='/2011/04/25/ejemplo_flyway.html' title='Ejemplo de migración de bases de datos para Java'>
                        &laquo; Flyway, migración de bases de datos
                      </a>
                    </h3>
                  </li>
                  <li>
                    <h3>
                      <a href='/2011/04/24/intro_android.html' title='Introduciendo Android, el SO para móviles de Google'>
                        &laquo; Introducción a Android
                      </a>
                    </h3>
                  </li>
                  <li>
                    <h3>
                      <a href='/2011/04/04/tips_mobile.html' title='Tips para desarrollo de aplicaciones móviles.'>
                        &laquo; Desarrollo de aplicaciones móviles
                      </a>
                    </h3>
                  </li>
                </ul>
              </div>
              <div class='newer'>
                <ul>
                  <li>
                    <h3>
                      <a href='/tips/siteadmin.html' title='Comandos utiles para la administración de mi página web estática'>
                        Administración de sitio web estático &raquo;
                      </a>
                    </h3>
                  </li>
                  <li>
                    <h3>
                      <a href='/2011/10/21/cassandra_cli.html' title='Comandos básicos para el cliente (consola) de Cassandra'>
                        Usando Cassandra_CLI (Básico) &raquo;
                      </a>
                    </h3>
                  </li>
                  <li>
                    <h3>
                      <a href='/2011/10/21/cassandra_hector.html' title='Uso de la biblioteca Hector para accesar Cassandra'>
                        Cassandra y Hector &raquo;
                      </a>
                    </h3>
                  </li>
                </ul>
              </div>
            </div>
        <div class='clear'></div>
        <div class='comments'>
              <div id='disqus_thread'></div>
              <script src='http://disqus.com/forums/emiguelwebpage/embed.js' type='text/javascript'></script>
              <noscript>
                <a href='http://disqus.com/forums/emiguelwebpage/?url=ref'>
                  View the discussion thread
                </a>
              </noscript>
            </div>
            <!-- / disqus adds too much visual crap -->
            <style type='text/css'>
              .dsq-dc-logo {
                display: none !important; }
            </style>
      </div>
      <div class='clear'></div>
    </div>
    <script type='text/javascript'>
          //<![CDATA[
            (function() {
              var links = document.getElementsByTagName('a');
              var query = '?';
              for(var i = 0; i < links.length; i++) {
                if(links[i].href.indexOf('#disqus_thread') >= 0) {
                  query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
                }
              }
              document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/emiguelwebpage/get_num_replies.js' + query + '"></' + 'script>');
            })();
          //]]>
        </script>
    <script type='text/javascript'>
          //<![CDATA[
            var pkBaseURL = (("https:" == document.location.protocol) ? "https://sourceforge.net/userapps/piwik/emigueltriana/" : "http://sourceforge.net/userapps/piwik/emigueltriana/");
            document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
          //]]>
        </script>
        <script type='text/javascript'>
          //<![CDATA[
            try {
              var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
              piwikTracker.trackPageView();
              piwikTracker.enableLinkTracking();
            } catch( err ) {}
          //]]>
        </script>
        <noscript>
          <p>
            <img alt='' src='http://sourceforge.net/userapps/piwik/emigueltriana/piwik.php?idsite=1' style='border:0' />
          </p>
        </noscript>
  </body>
</html>
